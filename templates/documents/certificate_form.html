{% extends 'base.html' %}

{% block title %}{{ title }} - Jewelry Store ERP{% endblock %}

{% block extra_css %}
<!-- Tom Select for searchable dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<style>
    .ts-wrapper { width: 100%; }
    .ts-control { min-height: 38px; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-file-earmark-pdf me-2"></i>{{ title }}</h2>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        {{ form.non_field_errors.0 }}
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        <label for="id_item" class="form-label">Jewelry Item *</label>
                        {{ form.item }}
                        {% if form.item.errors %}<div class="text-danger small">{{ form.item.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="id_invoice" class="form-label">Related Invoice (optional)</label>
                        {{ form.invoice }}
                        <small class="text-muted d-block">Link to a paid invoice</small>
                        {% if form.invoice.errors %}<div class="text-danger small">{{ form.invoice.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="id_customer" class="form-label">Direct Customer Link (optional)</label>
                        {{ form.customer }}
                        <small class="text-muted d-block">Link directly to a customer (choose either invoice or customer)</small>
                        {% if form.customer.errors %}<div class="text-danger small">{{ form.customer.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-file-earmark-pdf me-1"></i>Generate Certificate
                        </button>
                        <a href="{% url 'documents:certificate_list' %}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Tom Select for searchable dropdowns -->
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script>
(function() {
    // Initialize Tom Select for Jewelry Item dropdown
    const itemSelect = document.getElementById('id_item');
    if (itemSelect) {
        new TomSelect(itemSelect, {
            valueField: 'id',
            labelField: 'text',
            searchField: ['sku', 'name', 'text'],
            placeholder: 'Search by SKU or name...',
            openOnFocus: true,
            preload: 'focus',
            load: function(query, callback) {
                fetch('/inventory/search/?q=' + encodeURIComponent(query))
                    .then(response => response.json())
                    .then(data => callback(data.results))
                    .catch(() => callback());
            },
            render: {
                option: function(data, escape) {
                    if (data.sku) {
                        return '<div class="d-flex justify-content-between">' +
                            '<span><strong>' + escape(data.sku) + '</strong> - ' + escape(data.name) + '</span>' +
                            '<span class="text-muted">€' + escape(data.sale_price) + '</span>' +
                        '</div>';
                    } else {
                        return '<div>' + escape(data.text || '') + '</div>';
                    }
                },
                item: function(data, escape) {
                    if (data.sku) {
                        return '<div>' + escape(data.sku) + ' - ' + escape(data.name) + '</div>';
                    } else {
                        return '<div>' + escape(data.text || '') + '</div>';
                    }
                }
            }
        });
    }
    
    // Initialize Tom Select for Invoice dropdown
    const invoiceSelect = document.getElementById('id_invoice');
    if (invoiceSelect) {
        new TomSelect(invoiceSelect, {
            valueField: 'id',
            labelField: 'text',
            searchField: ['invoice_number', 'customer', 'text'],
            placeholder: 'Search by invoice #...',
            openOnFocus: true,
            preload: 'focus',
            load: function(query, callback) {
                fetch('/sales/search/?q=' + encodeURIComponent(query))
                    .then(response => response.json())
                    .then(data => callback(data.results))
                    .catch(() => callback());
            },
            render: {
                option: function(data, escape) {
                    if (data.invoice_number) {
                        return '<div class="d-flex justify-content-between">' +
                            '<span><strong>' + escape(data.invoice_number) + '</strong> - ' + escape(data.customer) + '</span>' +
                            '<span class="text-muted">€' + escape(data.total) + ' (' + escape(data.status) + ')</span>' +
                        '</div>';
                    } else {
                        return '<div>' + escape(data.text || '') + '</div>';
                    }
                },
                item: function(data, escape) {
                    if (data.invoice_number) {
                        return '<div>' + escape(data.invoice_number) + ' - ' + escape(data.customer) + '</div>';
                    } else {
                        return '<div>' + escape(data.text || '') + '</div>';
                    }
                }
            }
        });
    }
    
    // Initialize Tom Select for Customer dropdown
    const customerSelect = document.getElementById('id_customer');
    if (customerSelect) {
        new TomSelect(customerSelect, {
            valueField: 'id',
            labelField: 'text',
            searchField: ['name', 'email', 'text'],
            placeholder: 'Search by customer name...',
            openOnFocus: true,
            preload: 'focus',
            load: function(query, callback) {
                fetch('/crm/customers/search/?q=' + encodeURIComponent(query))
                    .then(response => response.json())
                    .then(data => callback(data.results))
                    .catch(() => callback());
            },
            render: {
                option: function(data, escape) {
                    if (data.name) {
                        return '<div>' +
                            '<div><strong>' + escape(data.name) + '</strong></div>' +
                            (data.email ? '<small class="text-muted">' + escape(data.email) + '</small>' : '') +
                        '</div>';
                    } else {
                        return '<div>' + escape(data.text || '') + '</div>';
                    }
                },
                item: function(data, escape) {
                    if (data.name) {
                        return '<div>' + escape(data.name) + (data.email ? ' (' + escape(data.email) + ')' : '') + '</div>';
                    } else {
                        return '<div>' + escape(data.text || '') + '</div>';
                    }
                }
            }
        });
    }
})();
</script>
{% endblock %}
